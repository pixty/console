package model

import (
	"fmt"

	"github.com/pixty/console/common"
)

type (
	// Organization DO.
	Organization struct {
		Id   int64
		Name string
	}

	// FieldInfo - describes a field of profile metadata
	FieldInfo struct {
		Id          int64
		OrgId       int64
		FieldType   string
		DisplayName string
	}

	// Type of the field please see FLD_TYPE_ constants below
	FieldType string

	// User DO
	User struct {
		Login string
		Email string
		Salt  string
		Hash  string
	}

	// User Role DO
	UserRole struct {
		Login string
		OrgId int64
		Role  int
	}

	// Camera DO
	Camera struct {
		Id        string // friendly camera name
		OrgId     int64
		SecretKey string // this is not the key actually, but its hash
	}

	// A person DO
	Person struct {
		// Person id is generated by Frame Processor
		Id         string
		CamId      string
		LastSeenAt uint64
		ProfileId  int64
		PictureId  string // avatar
		MatchGroup int64
	}

	// Point on a 2D plane
	Point struct {
		X int `json:"x"`
		Y int `json:"y"`
	}

	// A rectangle on a 2D plane
	Rectangle struct {
		LeftTop     Point `json:"leftTop"`
		RightBottom Point `json:"rightBottom"`
	}

	// A size on 2D plane
	Size struct {
		Width  int `json:"Width" bson:"width"`
		Height int `json:"Height" bson:"height"`
	}

	// A face description DO
	Face struct {
		Id          int64
		SceneId     string
		PersonId    string
		CapturedAt  uint64
		ImageId     string
		Rect        Rectangle //composite, dao has transformations
		FaceImageId string
		V128D       common.V128D //composite, dao has transformations
	}

	// An organization profile's information
	Profile struct {
		Id        int64
		OrgId     int64
		PictureId string // avatar

		//Meta (composit one)
		Meta []*ProfileMeta
	}

	ProfileMeta struct {
		ProfileId int64
		FieldId   int64
		Value     string

		//Display Name can be populated for some certain ops
		DisplayName string
	}

	// Persister is an interface which provides an access to persistent layer
	Persister interface {
		// Returns an TX objecct for accessing to Main DB
		GetMainTx() (MainTx, error)
		// Returns an TX object for accessing to Pratitioned DB
		GetPartitionTx(partId string) (PartTx, error)
	}

	// The Tx object allows to control general DB operations. It also supports
	// explicit transactions control via BeginXXX() methods, where XXX is isolation
	// level. If a transaction was opened, it MUST be closed via Rollback() or Commit()
	// methods. It is good style to write ``` defer tx.Close()```
	//
	// If transaction was not opened by a BeginXXX method, every statement is safe
	// to be run and it will be executed in its own transaction.
	//
	// Implementation is not thread safe, so please keep eye on not use same
	// object in multi-go routines call, or guard calls accordingly.
	Tx interface {
		// Begins transaction with Serializable isolation level, will
		// close previous transaction if it was opened, but not closed before
		BeginSerializable() error

		// Begin transaction with default isolation level. The method closes
		// previous transaction if it was opened on the moment of the call
		Begin() error
		Rollback() error
		Commit() error

		// Executes provided SQL query
		ExecQuery(sqlQuery string, params ...interface{}) error
		// Executes SQL script which is in the provided file
		ExecScript(pathToFile string) error
	}

	// An transactional persister (has context dependant time)
	MainTx interface {
		Tx

		FindCameraById(camId string) (*Camera, error)

		// orgs
		InsertOrg(org *Organization) (int64, error)
		GetOrg(orgId int64) (*Organization, error)

		// users
		InsertUser(user *User) error
		GetUserByLogin(login string) (*User, error)
		UpdateUser(user *User) error
		InsertUserRoles(ur []*UserRole) error
		DeleteUserRoles(q *UserRoleQuery) error
		FindUserRoles(q *UserRoleQuery) ([]*UserRole, error)
	}

	// Partitioned persister
	PartTx interface {
		Tx

		// ==== Cams ====
		InsertCamera(cam *Camera) error
		GetCameraById(camId string) (*Camera, error)
		UpdateCamera(cam *Camera) error
		DeleteCamera(camId string) error
		FindCameras(q *CameraQuery) ([]*Camera, error)

		// ==== Faces ====
		// returns Face by its Id, or error
		GetFaceById(pId int64) (*Face, error)
		FindFaces(fQuery *FacesQuery) ([]*Face, error)
		// insert new face, returns the new record id, or error, if it happens
		InsertFace(face *Face) (int64, error)
		InsertFaces(faces []*Face) error

		// ==== Persons ====
		// returns Person by its Id, or error
		CheckPersonInOrg(pId string, orgId int64) (bool, error)
		GetPersonById(pId string) (*Person, error)
		FindPersons(pQuery *PersonsQuery) ([]*Person, error)
		// insert new person, returns the new record id, or error, if it happens
		InsertPerson(person *Person) error
		InsertPersons(persons []*Person) error
		UpdatePerson(person *Person) error
		UpdatePersonsLastSeenAt(pids []string, lastSeenAt uint64) error

		// ==== FieldInfos ====
		GetFieldInfo(fldId int64) (*FieldInfo, error)
		GetFieldInfos(orgId int64) ([]*FieldInfo, error)
		InsertFieldInfos(fldInfo []*FieldInfo) error
		UpdateFiledInfo(fldInfo *FieldInfo) error
		DeleteFieldInfo(fldInfo *FieldInfo) error

		// ==== Profiles ====
		CheckProfileInOrgWithCam(prId int64, camId string) (bool, error)
		InsertProfile(prf *Profile) (int64, error)
		UpdateProfile(prf *Profile) error
		DeleteProfile(prfId int64) error
		InsertProfleMetas(pms []*ProfileMeta) error
		GetProfileMetas(prfIds []int64) ([]*ProfileMeta, error)
		DeleteAllProfileMetas(prfId int64) error
		GetProfiles(prQuery *ProfileQuery) ([]*Profile, error)
		// Looking for profiles for requiested match groups
		// profileId -> mg
		GetProfilesByMGs(matchGroups []int64) (map[int64]int64, error)
	}

	CameraQuery struct {
		OrgId int64
	}

	FacesQuery struct {
		// Request faces for the list of persons
		PersonIds []string
		// Indicates to read short version (no V128D vectors) of faces
		Short bool
		Limit int
	}

	PersonsQuery struct {
		// Camera Id the request done for
		CamId string
		// The maximum allowable max time.
		MaxLastSeenAt common.Timestamp
		// Request only this persons (MaxLastSeenAt and Limit will be disregarded)
		PersonIds []string
		// How many to select
		Limit int
	}

	ProfileQuery struct {
		ProfileIds []int64
		// Indicates, that meta is not needed
		NoMeta bool
	}

	UserRoleQuery struct {
		OrgId int64
		Login string
	}
)

// Known field types for profile fields description
const (
	FLD_TYPE_STRING FieldType = "string"
)

func (c *Camera) String() string {
	return fmt.Sprintf("{Id=%s, OrgId=%d, SecretKey=%s}", c.Id, c.OrgId, c.SecretKey)
}

func (q *PersonsQuery) String() string {
	return fmt.Sprintf("{CamId=%s, PersonsIds=%v, MaxLastSeenAt=%d, Limit=%d}", q.CamId, q.PersonIds, q.MaxLastSeenAt, q.Limit)
}

func (q *FacesQuery) String() string {
	return fmt.Sprintf("{PersonsIds=%v, Limit=%d}", q.PersonIds, q.Limit)
}

func (q *ProfileQuery) String() string {
	return fmt.Sprintf("{ProfileIds=%v}", q.ProfileIds)
}
